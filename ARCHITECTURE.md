# 系统架构文档

## 概述

全自动AI小说生成系统基于 **Anthropic 长运行代理最佳实践** 构建，采用**增量式进展**和**清晰工件**的设计理念。

## 核心架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        NovelGenerator                           │
│                        (主控制器)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  Initializer  │   │    Writer     │   │   Reviewer    │
│    Agent      │   │    Agent      │   │    Agent      │
│  (初始化代理)  │   │  (写作代理)   │   │  (审查代理)   │
└───────────────┘   └───────────────┘   └───────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│    Progress   │   │    Chapter    │   │   Character   │
│    Manager    │   │    Manager    │   │    Manager    │
│  (进度管理)   │   │  (章节管理)   │   │  (角色管理)   │
└───────────────┘   └───────────────┘   └───────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        项目文件结构                              │
│  novels/{title}/                                                │
│  ├── outline.md          (大纲)                                 │
│  ├── characters.json     (角色设定)                             │
│  ├── chapter-list.json   (章节列表 - Feature List)              │
│  ├── novel-progress.txt  (进度文件)                             │
│  ├── chapters/           (章节内容)                             │
│  └── reviews/            (审查报告)                             │
└─────────────────────────────────────────────────────────────────┘
```

## 工作流程

### 阶段1: 初始化 (Initializer Agent)

```
用户输入配置
    │
    ▼
┌─────────────────┐
│ 分析用户需求    │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────────┐
│ 大纲  │ │ 角色设定  │
└───┬───┘ └─────┬─────┘
    │           │
    └─────┬─────┘
          │
          ▼
┌─────────────────┐
│ 章节列表        │  ← Feature List (Anthropic模式)
│ (chapter-list)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 进度文件        │  ← novel-progress.txt
│ (初始化状态)    │
└─────────────────┘
```

### 阶段2: 写作循环 (Writer Agent)

```
┌─────────────────────────────────────────────────────────────┐
│                      写作循环 (多会话)                        │
└─────────────────────────────────────────────────────────────┘

每次会话:
┌─────────────┐
│ 读取进度文件 │  ← 了解已完成内容
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 选择下一章节 │  ← 获取pending状态的章节
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 加载上下文   │  ← 大纲、角色、前一章节
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 创作内容     │  ← LLM生成章节内容
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 自我审查     │  ← 质量检查
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 保存章节     │  ← chapter-XXX.md
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 更新进度     │  ← novel-progress.txt
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Git提交     │  ← 版本控制
└─────────────┘
       │
       │ (循环直到所有章节完成)
       └──────────────────────┐
                              │
                              ▼
                    ┌─────────────────┐
                    │  写作阶段完成   │
                    └─────────────────┘
```

### 阶段3: 审查 (Reviewer Agent)

```
┌─────────────────────────────────────────────────────────────┐
│                      质量审查                                 │
└─────────────────────────────────────────────────────────────┘

对每个章节:

章节内容
    │
    ▼
┌─────────────────────────────────────────┐
│          多维度质量评估                  │
├─────────────────────────────────────────┤
│  情节连贯性  │  角色一致性  │  写作质量  │
│  (8.5/10)   │  (7.8/10)   │  (8.0/10)  │
├─────────────────────────────────────────┤
│  吸引力     │  技术准确性  │            │
│  (7.5/10)   │  (9.0/10)   │            │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────┐
│ 生成审查报告    │  ← review-XXX.md
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 判断是否通过    │  ← 总分 >= 7.0?
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────────┐
│ 通过  │ │ 需要修改  │
│ ✅    │ │ ❌        │
└───────┘ └───────────┘
```

## 关键设计模式

### 1. 增量式进展 (Incremental Progress)

**Anthropic 文章核心洞察**: 代理应该一次只处理一个小的、明确的任务。

```python
# Writer Agent 的工作方式
class WriterAgent:
    def write_session(self):
        # 1. 读取进度
        progress = self._load_progress()
        
        # 2. 获取下一个章节（一次只处理一个）
        chapter = self._get_next_chapter(progress)
        
        # 3. 创作这个章节
        content = self._write_chapter(chapter)
        
        # 4. 保存并更新进度
        self._save_chapter(chapter, content)
        self._update_progress(chapter)
        
        # 5. 提交到版本控制
        self._git_commit(chapter)
```

### 2. 清晰工件 (Clear Artifacts)

**Anthropic 文章核心洞察**: 每个会话应该留下清晰的工件，让下一个会话能够快速理解状态。

```
工件类型:
├── novel-progress.txt      (状态跟踪)
│   └── 记录每个章节的状态、字数、质量分数
│
├── chapter-list.json       (任务列表)
│   └── 每个章节的规格、关键情节点、涉及角色
│
├── chapter-XXX.md          (内容工件)
│   └── 实际的章节内容
│
├── review-XXX.md           (质量报告)
│   └── 审查结果和改进建议
│
└── Git提交历史             (版本控制)
    └── 每次完成的描述性提交
```

### 3. 上下文管理 (Context Management)

```python
# Writer Agent 加载的上下文
def _load_writing_context(self, chapter_number):
    context = {
        'outline': self._load_outline(),           # 整体大纲
        'characters': self._load_characters(),     # 角色设定
        'current_chapter': self._get_chapter_spec(chapter_number),
        'style_guide': self._load_style_guide(),   # 写作风格
        'previous_chapter': self._load_previous(chapter_number)  # 前一章
    }
    return context
```

### 4. Feature List 模式

对应 Anthropic 文章中的 `feature_list.json`：

```json
{
  "chapter_number": 1,
  "title": "第一章：神秘信号",
  "summary": "天文学家林晓接收到神秘信号",
  "key_plot_points": [
    "林晓发现异常信号",
    "信号来自4光年外",
    "决定深入研究"
  ],
  "characters_involved": ["林晓", "王教授"],
  "word_count_target": 3000,
  "status": "completed"
}
```

## 数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   用户输入   │────▶│  Initializer │────▶│  项目文件   │
│  (配置)     │     │    Agent    │     │  (初始化)   │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   完整小说   │◀────│   Merger    │◀────│   章节文件  │
│  (输出)     │     │             │     │  (chapters) │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │    Writer   │
                                        │    Agent    │
                                        │  (循环写作)  │
                                        └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Reviewer  │
                                        │    Agent    │
                                        │  (质量审查)  │
                                        └─────────────┘
```

## 扩展点

### 1. 添加新的代理

```python
# 创建新的代理类
class EditorAgent:
    """编辑代理 - 专门负责润色和修改"""
    
    def edit_chapter(self, chapter_number):
        # 加载章节
        # 进行深度编辑
        # 保存修改
        pass
```

### 2. 自定义质量评估

```python
# 扩展 Reviewer Agent
class CustomReviewer(ReviewerAgent):
    def _evaluate_style_consistency(self, content):
        # 自定义风格一致性检查
        pass
```

### 3. 集成真实LLM

```python
# 替换 MockLLMClient
class ClaudeLLMClient:
    def __init__(self, api_key):
        self.client = anthropic.Anthropic(api_key=api_key)
    
    def generate(self, prompt, **kwargs):
        response = self.client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=4000,
            temperature=0.8,
            messages=[{"role": "user", "content": prompt}]
        )
        return response.content[0].text
```

## 性能考虑

### 1. 上下文窗口管理

- 每次只加载必要的上下文
- 使用摘要而非完整内容
- 关键信息存储在进度文件中

### 2. 错误恢复

- 每个章节独立保存
- 进度文件定期更新
- Git版本控制支持回滚

### 3. 并行化潜力

```
当前: 顺序写作 (章节1 → 章节2 → 章节3)
未来: 并行写作 (如果章节间依赖较少)
       章节1 ──┐
       章节2 ──┼──▶ 合并
       章节3 ──┘
```

## 安全考虑

1. **内容过滤** - 在LLM输出后添加内容审查
2. **隐私保护** - 不在提示中暴露敏感信息
3. **版本控制** - Git历史可以追踪所有更改

## 总结

本系统严格遵循 Anthropic 文章中的最佳实践：

1. ✅ **Initializer Agent** - 首次运行时设置完整环境
2. ✅ **增量式进展** - 一次只处理一个章节
3. ✅ **清晰工件** - 进度文件、章节文件、审查报告
4. ✅ **Feature List** - 章节列表明确任务规格
5. ✅ **自我验证** - 质量评估和修改建议
6. ✅ **版本控制** - Git提交保存历史

这种架构确保了：
- **可靠性** - 每个步骤都有明确的输入输出
- **可恢复性** - 任何时候都可以从中断处继续
- **可扩展性** - 易于添加新功能
- **可维护性** - 清晰的模块划分
