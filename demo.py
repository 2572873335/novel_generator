#!/usr/bin/env python3
"""
???AI?????? - ????
??????????????
"""

import os
import sys
import json
import shutil

# ??????????
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# ????????????
from core.progress_manager import ProgressManager
from core.chapter_manager import ChapterManager
from core.character_manager import CharacterManager


def demo_progress_manager():
    """???????"""
    print("\n" + "="*60)
    print("? ??: ?????")
    print("="*60)
    
    # ????????
    demo_dir = "demo_project"
    os.makedirs(demo_dir, exist_ok=True)
    
    # ????????
    pm = ProgressManager(demo_dir)
    
    # ????????
    chapter_titles = [
        "??????",
        "??????",
        "??????",
        "??????",
        "??????",
        "??????"
    ]
    
    # ?????
    progress = pm.initialize_progress(
        title="????",
        genre="??",
        total_chapters=6,
        chapter_titles=chapter_titles
    )
    
    print(f"? ???????")
    print(f"  ??: {progress.title}")
    print(f"  ???: {progress.total_chapters}")
    
    # ????????
    print("\n??????...")
    pm.update_chapter_progress(1, status='completed', word_count=3200, quality_score=8.5)
    pm.update_chapter_progress(2, status='completed', word_count=2800, quality_score=7.8)
    pm.update_chapter_progress(3, status='writing', word_count=1500)
    
    # ??????
    report = pm.generate_progress_report()
    print(report)
    
    # ??????
    print(f"??????: {pm.is_novel_complete()}")
    
    # ???????????
    next_chapter = pm.get_next_pending_chapter()
    if next_chapter:
        print(f"????????: ?{next_chapter.chapter_number}? - {next_chapter.title}")
    
    # ??
    import shutil
    shutil.rmtree(demo_dir)
    print("\n? ????????????")


def demo_chapter_manager():
    """???????"""
    print("\n" + "="*60)
    print("? ??: ?????")
    print("="*60)
    
    demo_dir = "demo_project"
    os.makedirs(demo_dir, exist_ok=True)
    
    cm = ChapterManager(demo_dir)
    
    # ??????
    outline_data = {
        'chapters': [
            {
                'title': '????????',
                'summary': '??????????????????',
                'key_plot_points': ['????????', '????4???', '??????'],
                'characters_involved': ['??', '?????'],
                'word_count_target': 3000
            },
            {
                'title': '????????',
                'summary': '?????????????????',
                'key_plot_points': ['??????', '??????', '????????'],
                'characters_involved': ['??', '????'],
                'word_count_target': 3500
            }
        ]
    }
    
    chapters = cm.create_chapter_list(outline_data)
    print(f"? ??? {len(chapters)} ???")
    
    # ??????
    for ch in chapters:
        print(f"\n?{ch.chapter_number}?: {ch.title}")
        print(f"  ??: {ch.summary[:50]}...")
        print(f"  ?????: {len(ch.key_plot_points)}?")
        print(f"  ????: {', '.join(ch.characters_involved)}")
    
    # ??????
    prompt = cm.generate_writing_prompt(1)
    print(f"\n??????:\n{prompt[:300]}...")
    
    # ????
    test_content = "????????????????????4?????????????"
    validation = cm.validate_completion(1, test_content)
    print(f"\n????:")
    print(f"  ??: {validation['valid']}")
    print(f"  ??: {validation['word_count']}")
    print(f"  ??: {validation['errors']}")
    print(f"  ??: {validation['warnings']}")
    
    # ??
    shutil.rmtree(demo_dir)
    print("\n? ????????????")


def demo_character_manager():
    """???????"""
    print("\n" + "="*60)
    print("? ??: ?????")
    print("="*60)
    
    demo_dir = "demo_project"
    os.makedirs(demo_dir, exist_ok=True)
    
    chm = CharacterManager(demo_dir)
    
    # ????
    characters_data = [
        {
            'name': '??',
            'role': 'protagonist',
            'age': 28,
            'appearance': '?????????????????????',
            'personality': '????????????????????',
            'background': '???????????????????',
            'motivation': '??????????????????',
            'character_arc': '????????????????????',
            'relationships': {'???': '??????', '??': '?????'},
            'distinctive_features': ['???????????', '????????'],
            'speech_patterns': '???????????????'
        },
        {
            'name': '???',
            'role': 'supporting',
            'age': 55,
            'appearance': '???????????????????',
            'personality': '??????????',
            'background': '???????????????',
            'motivation': '?????????????????',
            'character_arc': '???????????',
            'relationships': {'??': '??????'},
            'distinctive_features': ['??????', '????????'],
            'speech_patterns': '?????????????'
        }
    ]
    
    characters = chm.create_characters(characters_data)
    print(f"? ??? {len(characters)} ???")
    
    # ??????
    for char in characters:
        print(f"\n{char.name} ({char.role})")
        print(f"  ??: {char.age}")
        print(f"  ??: {char.personality[:60]}...")
        print(f"  ??: {char.motivation[:60]}...")
    
    # ??????
    main_chars = chm.get_main_characters()
    print(f"\n????: {', '.join(c.name for c in main_chars)}")
    
    # ????????
    guide = chm.generate_character_guide()
    print(f"\n??????:\n{guide[:400]}...")
    
    # ?????
    test_content = "?????????????'???????????'"
    consistency = chm.check_character_consistency(test_content, ['??'])
    print(f"\n?????:")
    print(f"  ??: {consistency['consistent']}")
    print(f"  ??: {consistency['issues']}")
    
    # ??
    shutil.rmtree(demo_dir)
    print("\n? ????????????")


def demo_full_workflow():
    """????????"""
    print("\n" + "="*60)
    print("? ??: ??????")
    print("="*60)
    
    from core.novel_generator import create_novel
    
    # ????
    config = {
        'title': '?????????',
        'genre': '??',
        'target_chapters': 3,  # ????????
        'words_per_chapter': 1000,  # ????????
        'description': '???????????????'
    }
    
    print("??:")
    print(f"  ??: {config['title']}")
    print(f"  ??: {config['genre']}")
    print(f"  ??: {config['target_chapters']}")
    print(f"  ????: {config['words_per_chapter']}")
    
    print("\n????...")
    print("(?????????LLM?????????LLM API)")
    
    # ????
    result = create_novel(config)
    
    if result['success']:
        print(f"\n? ?????")
        print(f"????: {result['project_dir']}")
        print(f"??: {result['elapsed_time']:.2f}?")
        
        # ???????
        project_dir = result['project_dir']
        if os.path.exists(project_dir):
            files = os.listdir(project_dir)
            print(f"\n?????:")
            for f in sorted(files):
                print(f"  - {f}")
            
            # ??????
            chapters_dir = os.path.join(project_dir, 'chapters')
            if os.path.exists(chapters_dir):
                chapters = os.listdir(chapters_dir)
                print(f"\n???? ({len(chapters)}?):")
                for ch in sorted(chapters):
                    print(f"  - {ch}")
        
        # ??
        import shutil
        shutil.rmtree(project_dir)
        print(f"\n? ????????????")
    else:
        print(f"\n? ????")


def main():
    """???"""
    print("="*60)
    print("? ???AI?????? - ??")
    print("="*60)
    print("\n?????????????????")
    print("??????????????????LLM API")
    
    try:
        # ??????
        demo_progress_manager()
        demo_chapter_manager()
        demo_character_manager()
        demo_full_workflow()
        
        print("\n" + "="*60)
        print("? ???????")
        print("="*60)
        print("\n?????LLM??????:")
        print("1. ??LLM API??")
        print("2. ?? agents/ ??LLM???")
        print("3. ??: python main.py --interactive")
        
    except Exception as e:
        print(f"\n? ????: {e}")
        import traceback
        traceback.print_exc()


if __name__ == '__main__':
    main()
